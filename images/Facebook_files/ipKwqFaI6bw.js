/*!CK:3217406093!*//*1419899803,*/

if (self.CavalryLogger) { CavalryLogger.start_js(["AGhIW"]); }

__d("FeedAdsGapRuleViolationDetection",["Arbiter","Banzai","CSS","csx","cx","DOM","ge"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n='ei',o='qid',p='gap rule violation',q='non violating ads gap',r='first position violation',s='feed load',t='first position invalidation',u='spacing invalidation',v=[],w=[],x=[],y={registerFeedStories:function(z,aa){if(z.containerID=='substream_0'){v=[];w=[];}var ba=m(z.containerID);if(!ba){i.removeClass(aa,'hidden_elem');return;}var ca=l.scry(ba,"div._5jmm").map(this._convertStoryNodeToObject).filter(function(da){return da!==null;});if(z.isLoggingEnabled&&ca.length!==0)this._logFeedLoad();if(z.isNewerStories){v=ca.concat(v);}else v=v.concat(ca);this._checkFirstPosViolation(z);this._checkGapRuleViolation(z);i.removeClass(aa,'hidden_elem');g.inform('feedAdsInvalidation/done');},_convertStoryNodeToObject:function(z){if(i.hasClass(z,"_170y"))return null;var aa=l.scry(z,"div._hye"),ba=l.scry(z,"li._170x"),ca=[];if(aa.length!==0){ca=aa.map(function(fa){return fa.getAttribute('data-ft');}).filter(function(fa){return fa!==null;});}else if(ba.length!==0){ca=ba.map(function(fa){return fa.getAttribute('data-ft');}).filter(function(fa){return fa!==null;});}else if(z.getAttribute('data-ft'))ca=[z.getAttribute('data-ft')];if(!ca.length)return null;var da=JSON.parse(ca[0]),ea={dataFTArray:ca,dedupKey:z.getAttribute('data-dedupekey'),isSponsored:!!da[n],height:z.offsetHeight,qid:parseInt(da[o],10),nodeID:z.id};return ea;},_checkFirstPosViolation:function(z){while(v.length>0&&v[0].isSponsored){var aa={ftArray:v[0].dataFTArray,qid:v[0].qid,nodeid:v[0].nodeID};if(z.isLoggingEnabled&&!(v[0].dedupKey in x)){this._logFirstPosViolation(aa);x[v[0].dedupKey]=aa;}if(z.isInvalidationEnabled){this._invalidateFirstPosAd(aa);v.splice(0,1);}else break;}},_checkGapRuleViolation:function(z){var aa=null,ba=null,ca=0;for(var da=0;da<v.length;da++){var ea=v[da];ca+=ea.height;if(ea.isSponsored){ca-=ea.height;var fa=false;if(aa!==null){var ga=da-aa,ha=null,ia=z.minGaps[ea.dedupKey];if(!ia)ia=z.defaultMinGap;if(ga<ia){ha=p;}else ha=q;var ja={ftArray_A:ba.dataFTArray,ftArray_B:ea.dataFTArray,dist:ga,pdist:ca,pos:da+1,qid_A:ba.qid,qid_B:ea.qid,event_type:ha,nodeid:ea.nodeID};if(z.isLoggingEnabled)if(!(ea.dedupKey in w)||w[ea.dedupKey].event_type!==ha){this._logGapRuleViolation(ja);w[ea.dedupKey]=ja;}if(z.isInvalidationEnabled&&ha==p){this._invalidateGapRuleViolatedAd(ja);fa=true;v.splice(da--,1);}}if(!fa){aa=da;ba=ea;ca=0;}}}},_logFirstPosViolation:function(z){var aa={ft:z.ftArray[0],event_type:r,intValues:{qid:z.qid}};h.post('feed_ads_gap_rule_violation',aa);},_logGapRuleViolation:function(z){var aa={ft_A:z.ftArray_A[0],ft_B:z.ftArray_B[0],event_type:z.event_type,intValues:{dist:z.dist,pdist:z.pdist,pos:z.pos,qid_A:z.qid_A,qid_B:z.qid_B}};h.post('feed_ads_gap_rule_violation',aa);},_logFeedLoad:function(){var z={event_type:s};h.post('feed_ads_gap_rule_violation',z);},_invalidateFirstPosAd:function(z){i.hide(m(z.nodeid));var aa={ft_array:z.ftArray,event_type:t};h.post('feed_ads_gap_rule_violation',aa);},_invalidateGapRuleViolatedAd:function(z){i.hide(m(z.nodeid));var aa={ft_array_A:z.ftArray_A,ft_array_B:z.ftArray_B,event_type:u};h.post('feed_ads_gap_rule_violation',aa);}};e.exports=y;},null);
__d("legacy:Selector",["SelectorDeprecated"],function(a,b,c,d){a.Selector=b('SelectorDeprecated');},3);